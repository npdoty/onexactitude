<!DOCTYPE html>
<head>
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
	<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.3"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
	<style type="text/css" media="screen">
		#map {
			height: 100%;
			padding: 0;
			margin: 0;
			z-index: 10;
			opacity: 0.8;
		}
		#base {
			position: absolute;
			top: 0;
			height: 100%;
			width: 100%;
			padding: 0;
			margin: 0;
			z-index: 0;
		}
		html, body {
			height: 100%;
			padding: 0;
			margin: 0;
		}
	</style>
	<script type="text/javascript" charset="utf-8">
		// tile methods provided by: http://wiki.openstreetmap.org/wiki/Slippy_map_tilenames
		function long2tile(lon,zoom) { return (Math.floor((lon+180)/360*Math.pow(2,zoom))); }
		function lat2tile(lat,zoom)  { return (Math.floor((1-Math.log(Math.tan(lat*Math.PI/180) + 1/Math.cos(lat*Math.PI/180))/Math.PI)/2 *Math.pow(2,zoom))); }

		function xyForLatLngZoom(lat, lng, zoom) {
			var x = long2tile(lng, zoom);
			var y = lat2tile(lat, zoom);
			return {x: x, y: y};
		}
		
		function dpi() {	// a fine attempt, but still returns 96dpi for high-res but non-retina screens like mine
			for (var i = 70; i < 400; i++) {
				if (!window.matchMedia('(min-resolution: '+ i + 'dpi)').matches) {
					return i-1;
				}
			}
			return -1;	// browser doesn't support resolution in media queries (out-of-date webkit, e.g.)
		}
	
		$(function() {
			console.log('dpi based on matchMedia queries: ' + dpi());
			
			var startingCenter = [37.87198, -122.25789];
			var latitude = startingCenter[0];
			var screenDpi = dpi() > -1 ? dpi() : 96;
			var targetZoom = Math.log(screenDpi * 39.37 * 156543.034 * Math.cos(latitude * Math.PI / 180)) / Math.log(2);
			
			console.log('zoom: ' + targetZoom);
			
			var map = L.map('map', {maxZoom: 31, attributionControl: false}).setView(startingCenter, targetZoom);
			window.map = map;	// useful for debugging
			var roadLayer = L.geoJson().addTo(map);	// empty GeoJSON layer to start with
			var buildingLayer = L.geoJson().addTo(map);
			var landLayer = L.geoJson().addTo(map);
			landLayer.bringToBack();
			
			L.control.scale({metric: false}).addTo(map);
			L.control.attribution({position: 'topright'}).addTo(map);
			
			var basemap = L.map('base', {attributionControl: false}).setView(startingCenter, 16);
			var layer = new L.StamenTileLayer("terrain");
			basemap.addLayer(layer);
			
			var center = map.getCenter();
			
			var vectorTileTemplates = [
				{
					template: "http://tile.openstreetmap.us/vectiles-highroad/", 
					fetchZoom: 17, 
					layer: roadLayer, 
					style: {"color": "#ff0000"}
				}, 
				{
					template: "http://tile.openstreetmap.us/vectiles-buildings/", 
					fetchZoom: 18, 
					layer: buildingLayer, 
					style: {"color": "#0000ff"}
				}, 
				{
					template: "http://tile.openstreetmap.us/vectiles-land-usages/", 
					fetchZoom: 14, 
					layer: landLayer, 
					style: {"color": "#00ff00"}
				}, 
			];
			
			for (var i = 0; i < vectorTileTemplates.length; i++) {
				var template = vectorTileTemplates[i];
				var tile = xyForLatLngZoom(center.lat, center.lng, template.fetchZoom);
				
				// Construct the json string out of the z, x and y
				var jsonString = template.template + template.fetchZoom + "/" + tile.x + "/" + tile.y + ".json";
				(function(template) { 
					$.getJSON( jsonString, function(json){
						template.layer.addData(json);	// add the json data
						template.layer.setStyle(template.style);	// and style based on the appropriate template
					} );
				}(template));	// curry to capture template for the current iteration
			}
		});
	</script>
	<title>On Exactitude in Science</title>
</head>
<body>
	<div id="map"></div>
	<div id="base"></div>
</body>